<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pemilihan Ketua</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Aktifkan dark mode otomatis
    tailwind.config = {
      darkMode: 'media', // otomatis mengikuti sistem
      theme: {
        extend: {
          colors: {
            primary: "#3b82f6",
            primaryDark: "#2563eb"
          }
        }
      }
    };
  </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center p-6 text-gray-900 dark:text-gray-100 transition">

  <h1 class="text-3xl font-extrabold mb-8 tracking-wide">Pemilihan Ketua Organisasi</h1>

  <div id="cards" class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
    <!-- Template Kandidat -->
    <div class="card bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 flex flex-col items-center hover:shadow-2xl transition">
      <img src="img/1.jpg" class="w-28 h-28 rounded-full mb-4 ring-4 ring-primary/20 dark:ring-primaryDark/40">
      <h2 class="font-bold text-xl">Kandidat 1</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-6 text-center">Deskripsi singkat kandidat 1</p>
      <button onclick="vote('Kandidat 1', this)" 
        class="mt-auto bg-primary text-white px-5 py-2 rounded-lg hover:bg-primaryDark transition disabled:bg-gray-500 disabled:cursor-not-allowed">
        Pilih
      </button>
    </div>

    <div class="card bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 flex flex-col items-center hover:shadow-2xl transition">
      <img src="img/1.jpg" class="w-28 h-28 rounded-full mb-4 ring-4 ring-primary/20 dark:ring-primaryDark/40">
      <h2 class="font-bold text-xl">Kandidat 2</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-6 text-center">Deskripsi singkat kandidat 2</p>
      <button onclick="vote('Kandidat 2', this)" 
        class="mt-auto bg-primary text-white px-5 py-2 rounded-lg hover:bg-primaryDark transition disabled:bg-gray-500 disabled:cursor-not-allowed">
        Pilih
      </button>
    </div>

    <div class="card bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 flex flex-col items-center hover:shadow-2xl transition">
      <img src="img/1.jpg" class="w-28 h-28 rounded-full mb-4 ring-4 ring-primary/20 dark:ring-primaryDark/40">
      <h2 class="font-bold text-xl">Kandidat 3</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-6 text-center">Deskripsi singkat kandidat 3</p>
      <button onclick="vote('Kandidat 3', this)" 
        class="mt-auto bg-primary text-white px-5 py-2 rounded-lg hover:bg-primaryDark transition disabled:bg-gray-500 disabled:cursor-not-allowed">
        Pilih
      </button>
    </div>

    <div class="card bg-white dark:bg-gray-800 shadow-lg rounded-2xl p-6 flex flex-col items-center hover:shadow-2xl transition">
      <img src="img/1.jpg" class="w-28 h-28 rounded-full mb-4 ring-4 ring-primary/20 dark:ring-primaryDark/40">
      <h2 class="font-bold text-xl">Kandidat 4</h2>
      <p class="text-gray-600 dark:text-gray-400 text-sm mb-6 text-center">Deskripsi singkat kandidat 4</p>
      <button onclick="vote('Kandidat 4', this)" 
        class="mt-auto bg-primary text-white px-5 py-2 rounded-lg hover:bg-primaryDark transition disabled:bg-gray-500 disabled:cursor-not-allowed">
        Pilih
      </button>
    </div>
  </div>

  <!-- Reset -->
  <div class="mt-10 w-full max-w-md text-center">
    <input id="resetKey" type="text" placeholder="Masukkan reset key"
      class="border dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg px-4 py-2 w-2/3 focus:ring-2 focus:ring-primary focus:outline-none transition" />
    <button onclick="resetVotes()" 
      class="ml-2 bg-red-500 text-white px-5 py-2 rounded-lg hover:bg-red-600 transition">
      Reset
    </button>
  </div>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzidGgaynk8KQ91FsobMGrQJmK7jF8HlRO8pGvAqOtkuaMkwbGL0RVLQcqd-4aX89Xh7w/exec";
  let selected = JSON.parse(localStorage.getItem("selectedVotes")) || [];


// Disable kandidat yg sudah dipilih sebelumnya
window.onload = () => {
  selected.forEach(name => {
    const card = [...document.querySelectorAll(".card")]
      .find(c => c.querySelector("h2").textContent === name);
    if (card) {
      const btn = card.querySelector("button");
        if (selected.length >= 2) disableAllButtons();
    }
  });
};


  function vote(name, btn) {
    if (selected.length >= 2) {
      showDialog("⚠️ Batas 2 kandidat", "Kamu hanya bisa memilih maksimal 2 kandidat.");
      return;
    }

    const device = localStorage.getItem("deviceId") || generateDeviceId();
    localStorage.setItem("deviceId", device);

    const data = new URLSearchParams();
    data.append("pilihan", name);
    data.append("device", device);

    // ⏳ tampilkan loading dialog
    const loader = showLoading("Menyimpan vote...");

    btn.disabled = true; // cegah klik dobel

    fetch(scriptURL, { method: "POST", body: data })
      .then(res => res.json())
      .then(res => {
        loader.remove(); // hapus loading
        if (res.status === "success") {
          selected.push(name);
          localStorage.setItem("selectedVotes", JSON.stringify(selected));
          disableButton(btn);
          showDialog("✅ Berhasil", "Vote untuk " + name + " berhasil disimpan!");
        } else {
          btn.disabled = false; // aktifkan lagi kalau gagal
          showDialog("❌ Gagal", "Gagal menyimpan vote: " + res.message);
        }
      })
      .catch(err => {
        loader.remove();
        btn.disabled = false;
        showDialog("⚠️ Error", err);
      });
  }

  function disableButton(btn) {
    btn.disabled = true;
    btn.textContent = "Sudah Dipilih";
  }

  function resetVotes() {
    const key = document.getElementById("resetKey").value;
    if (key === "RESET123") {
      localStorage.removeItem("selectedVotes");
      selected = [];
      location.reload();
    } else {
      showDialog("❌ Salah", "Reset key salah!");
    }
  }

  function generateDeviceId() {
    return "device-" + Math.random().toString(36).substr(2, 9);
  }

  // ✅ dialog sukses/gagal
  function showDialog(title, message) {
    const dialog = document.createElement("div");
    dialog.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-50";
    dialog.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-xl max-w-sm w-full text-center animate-fadeIn">
        <h3 class="text-lg font-bold mb-2">${title}</h3>
        <p class="text-gray-600 dark:text-gray-300 mb-4">${message}</p>
        <button onclick="this.closest('.fixed').remove()" 
          class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primaryDark transition">OK</button>
      </div>
    `;
    document.body.appendChild(dialog);
  }

  // ⏳ dialog loading
  function showLoading(message) {
    const dialog = document.createElement("div");
    dialog.className = "fixed inset-0 flex items-center justify-center bg-black/50 z-50";
    dialog.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-xl flex flex-col items-center space-y-3 animate-fadeIn">
        <div class="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
        <p class="text-gray-600 dark:text-gray-300">${message}</p>
      </div>
    `;
    document.body.appendChild(dialog);
    return dialog;
  }
</script>

</body>
</html>
