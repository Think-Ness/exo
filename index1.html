<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Santri Language Violation Form | LAC</title>

  <!-- Meta SEO -->
  <meta name="title" content="Santri Language Violation Form | LAC" />
  <meta name="description" content="LAC Violation Report â€” submit language violation records easily with QR scanning and responsive design." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://think-ness.github.io/lac" />
  <meta property="og:title" content="Santri Language Violation Form | LAC" />
  <meta property="og:description" content="Report language violations quickly and clearly." />
  <meta property="og:image" content="icons/icon1.png" />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="icon" type="image/png" href="icons/icon1.png" />
  <link rel="manifest" href="manifest.json" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #f8faff 0%, #eef2f8 100%);
      font-family: "Poppins", sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }
    .card {
      border: none;
      border-radius: 1rem;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow: hidden;
      transition: all 0.25s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }
    .card-header {
      background: linear-gradient(90deg, #0d6efd, #6610f2);
      color: #fff;
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      padding: 1rem 0.5rem;
    }
    .btn {
      border-radius: 0.75rem;
      font-weight: 600;
    }
    label {
      font-weight: 500;
    }
    textarea {
      resize: none;
    }
    .qr-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    #qrModal {
      border: 2px dashed #0d6efd;
      border-radius: 0.75rem;
      padding: 1rem;
      background: #f8f9fa;
    }
    @media (max-width: 768px) {
      .card-header h4 { font-size: 1.05rem; }
      .btn { font-size: 0.9rem; }
    }
  </style>
</head>
<body>

<div class="container py-4">
  <div class="col-lg-7 mx-auto">
    <div class="card">
      <div class="card-header">
        <h4 class="mb-1">ðŸ“‹ Santri Language Violation Report</h4>
        <small>Language Advisory Council</small>
      </div>
      <div class="card-body p-4 p-md-5">
        <form id="formViolation">
          <input type="hidden" id="reportId" />

          <div class="mb-3">
            <label for="regNo" class="form-label">Registration Number</label>
            <div class="qr-controls">
              <input type="text" id="regNo" class="form-control" placeholder="Scan QR or paste data" required />
              <select id="cameraSelect" class="form-select form-select-sm" style="max-width:220px; display:none;"></select>
              <button type="button" id="btnScan" class="btn btn-outline-primary">ðŸ“· Scan</button>
            </div>
            <small class="text-muted d-block mt-1">QR format: regNo | name | class | dorm | region</small>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" id="fullName" class="form-control" readonly />
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">Class</label>
              <input type="text" id="class" class="form-control" readonly />
            </div>
            <div class="col-md-3 mb-3">
              <label class="form-label">Region</label>
              <input type="text" id="region" class="form-control" readonly />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Violation Description</label>
            <textarea id="violation" class="form-control" rows="3" placeholder="Describe the language violation..." required></textarea>
          </div>

          <div class="mb-4">
            <label class="form-label">Witness Name</label>
            <input type="text" id="witness" class="form-control" placeholder="Enter witness name" required />
          </div>

          <div id="qrModal" style="display:none;">
            <div id="qr-reader"></div>
            <div class="mt-2 d-flex gap-2">
              <button type="button" id="stopScan" class="btn btn-danger btn-sm">Stop</button>
              <button type="button" id="pasteBtn" class="btn btn-secondary btn-sm">Paste QR Text</button>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 py-2 mt-3">
            Submit Report
          </button>

          <button id="installBtn" class="btn btn-outline-primary w-100 py-2 mt-3" style="display:none;">
            <i class="bi bi-download"></i> Install App
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
  // ðŸŸ¦ PWA Install
  let deferredPrompt;
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'block';
  });

  installBtn.addEventListener('click', async () => {
    installBtn.style.display = 'none';
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') console.log('App installed ðŸŽ‰');
    deferredPrompt = null;
  });

  // ðŸŸ¦ Register Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registered âœ…'))
      .catch(err => console.error('SW failed:', err));
  }

  // ðŸŸ¦ Violation Logic
  const API_URL = "https://script.google.com/macros/s/AKfycbx9DC2Hhr3X-zggxK8Ar_edDnURGToJ2-Cj2RlaAhIEInrVTng1Y9VYL9SPDgUASiVB/exec";

  $(function() {
    const generateId = () => 'L' + Date.now().toString(36).slice(-3) + Math.random().toString(36).slice(2,5).toUpperCase();
    $('#reportId').val(generateId());

    let html5QrCode, isScanning = false;

    const applyQrData = (txt) => {
      const [reg, name, cls, dorm, region] = txt.split('|').map(t => t.trim());
      $('#regNo').val(reg || ''); $('#fullName').val(name || '');
      $('#class').val(cls || ''); $('#region').val(region || '');
    };

    $('#btnScan').on('click', async () => {
      $('#qrModal').show();
      const cams = await Html5Qrcode.getCameras();
      if (!cams.length) return Swal.fire('No Camera', 'No camera detected.', 'error');

      const preferred = cams.find(c => /back|rear|environment/i.test(c.label)) || cams[0];
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(preferred.id, { fps: 10, qrbox: 250 },
        (decoded) => {
          applyQrData(decoded);
          Swal.fire({ icon:'success', title:'QR Scanned!', text:decoded, timer:1200, showConfirmButton:false });
          html5QrCode.stop();
          isScanning = false;
          $('#qrModal').hide();
        }
      );
      isScanning = true;
    });

    $('#stopScan').click(() => {
      if (isScanning && html5QrCode) html5QrCode.stop().then(() => {
        $('#qrModal').hide(); isScanning = false;
      });
    });

    $('#pasteBtn').click(() => {
      const txt = prompt('Paste QR text: regNo|name|class|dorm|region');
      if (txt) applyQrData(txt);
    });

    $('#regNo').on('input', function() {
      if (this.value.includes('|')) applyQrData(this.value);
    });

    $('#formViolation').submit(async e => {
      e.preventDefault();
      const data = {
        id: $('#reportId').val(),
        regNo: $('#regNo').val(),
        name: $('#fullName').val(),
        class: $('#class').val(),
        region: $('#region').val(),
        violation: $('#violation').val(),
        witness: $('#witness').val(),
      };

      if (!data.regNo) return Swal.fire('Oops!', 'Please scan or enter the registration number.', 'warning');

      Swal.fire({ title:'Submitting...', allowOutsideClick:false, didOpen:Swal.showLoading });

      try {
        await fetch(API_URL, { method:'POST', body:JSON.stringify(data) });
        Swal.fire({ icon:'success', title:'Report Submitted!', text:'Your report has been recorded.' });
        $('#formViolation')[0].reset();
        $('#reportId').val(generateId());
      } catch {
        Swal.fire('Error', 'Failed to submit report. Try again later.', 'error');
      }
    });
  });
</script>
</body>
</html>
